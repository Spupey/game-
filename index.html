<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Ultimate Mine Clicker - Большая игра</title>
<style>
  /* Стили для всей игры */
  @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

  body {
    margin: 0; background: linear-gradient(135deg, #0a1f2f, #061121);
    font-family: 'Roboto Mono', monospace;
    color: #ccddff;
    user-select: none;
    overflow-x: hidden;
  }

  #game-container {
    max-width: 960px;
    margin: 20px auto;
    background: #112233dd;
    border-radius: 20px;
    box-shadow: 0 0 25px #335588aa;
    padding: 15px 20px;
  }

  #top-bar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
  }

  .stat {
    font-size: 18px;
    padding: 6px 12px;
    background: #21364e88;
    border-radius: 12px;
    box-shadow: inset 0 0 8px #2a466a;
    user-select: none;
    min-width: 100px;
    text-align: center;
  }

  #upgrade-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-top: 10px;
  }

  button.upgrade-btn {
    flex: 1 1 180px;
    background: #335577cc;
    border: none;
    color: #aaddff;
    font-weight: 700;
    font-size: 16px;
    border-radius: 14px;
    padding: 10px;
    cursor: pointer;
    box-shadow: 0 0 12px #4477cc88;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.3s ease;
    user-select: none;
  }
  button.upgrade-btn:disabled {
    background: #22446655;
    color: #557799aa;
    cursor: not-allowed;
    box-shadow: none;
  }
  button.upgrade-btn:hover:not(:disabled) {
    background: #5588ccdd;
  }

  #messages {
    margin: 12px 0 20px 0;
    height: 22px;
    font-weight: 700;
    text-align: center;
    color: #99cc99;
  }

  canvas#game-canvas {
    display: block;
    margin: 0 auto;
    background: linear-gradient(180deg, #0a1a28 0%, #050a15 100%);
    border-radius: 18px;
    box-shadow: 0 0 24px #225599cc;
    max-width: 100%;
  }

  .icon {
    width: 30px;
    height: 30px;
  }

  /* Подсказка */
  #tooltip {
    position: absolute;
    background: #223344cc;
    color: #ccddffcc;
    padding: 8px 14px;
    border-radius: 14px;
    pointer-events: none;
    font-size: 14px;
    max-width: 320px;
    display: none;
    user-select: none;
    z-index: 10;
    box-shadow: 0 0 12px #3366ccbb;
  }
</style>
</head>
<body>

<div id="game-container">

  <div id="top-bar">
    <div class="stat" id="coal-count" title="Количество добытого угля">Уголь: 0</div>
    <div class="stat" id="per-click" title="Количество угля за один клик">Клик: 1</div>
    <div class="stat" id="per-second" title="Автоматическая добыча угля в секунду">Авто: 0</div>
  </div>

  <div id="upgrade-buttons">
    <!-- Кнопки апгрейдов создаются JS -->
  </div>

  <div id="messages"></div>

  <canvas id="game-canvas" width="920" height="500"></canvas>

</div>

<div id="tooltip"></div>

<script>
(() => {
  // ============== Подготовка контекста и переменных =================
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');

  const coalCountEl = document.getElementById('coal-count');
  const perClickEl = document.getElementById('per-click');
  const perSecondEl = document.getElementById('per-second');
  const upgradeButtonsContainer = document.getElementById('upgrade-buttons');
  const messagesEl = document.getElementById('messages');
  const tooltipEl = document.getElementById('tooltip');

  // Звуковой контекст
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AudioCtx();

  // ===================== Классы игры ==============================

  // Класс для генерации звуков
  class Sound {
    static playClick() {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'square';
      osc.frequency.setValueAtTime(440 + Math.random() * 220, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.07, audioCtx.currentTime);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.1);
    }
  }

  // Частица для эффекта клика
  class Particle {
    constructor(x, y, color) {
      this.x = x;
      this.y = y;
      this.size = 4 + Math.random() * 3;
      this.speedX = (Math.random() - 0.5) * 4;
      this.speedY = -2 - Math.random() * 3;
      this.alpha = 1;
      this.color = color || 'rgba(255,255,255,1)';
      this.decay = 0.02 + Math.random() * 0.02;
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      this.alpha -= this.decay;
      this.size *= 0.95;
    }
    draw(ctx) {
      ctx.save();
      ctx.fillStyle = this.color.replace('1)', `${this.alpha})`);
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }
  }

  // Класс Кирки с разными типами
  class Pickaxe {
    constructor(name, baseClick, iconPath, description) {
      this.name = name;
      this.level = 1;
      this.baseClick = baseClick;
      this.clickPower = baseClick;
      this.upgradeCost = 15;
      this.iconPath = iconPath;
      this.description = description;
    }

    upgrade(playerCoal) {
      if (playerCoal >= this.upgradeCost) {
        this.level++;
        this.clickPower *= 1.5;
        this.upgradeCost = Math.floor(this.upgradeCost * 2.5);
        return true;
      }
      return false;
    }

    getClickPower() {
      return Math.floor(this.clickPower);
    }
  }

  // Класс Игрока (хранит состояние)
  class Player {
    constructor() {
      this.coal = 0;
      this.pickaxe = new Pickaxe(
        "Стальная Кирка",
        1,
        'M10 2 L14 6 L10 10 L6 6 Z', // Просто пример иконки в SVG path (будем рисовать отдельно)
        "Обычная кирка, базовая добыча"
      );
      this.autoMineLevel = 0;
      this.autoMinePower = 0;
      this.autoMineCost = 50;
      this.autoMineIntervalMs = 1000;
      this.upgrades = [];
    }

    addCoal(amount) {
      this.coal += amount;
    }

    canAfford(cost) {
      return this.coal >= cost;
    }

    spendCoal(amount) {
      if(this.canAfford(amount)){
        this.coal -= amount;
        return true;
      }
      return false;
    }

    upgradePickaxe() {
      if(this.spendCoal(this.pickaxe.upgradeCost)) {
        this.pickaxe.upgrade(this.coal);
        return true;
      }
      return false;
    }

    buyAutoMine() {
      if(this.spendCoal(this.autoMineCost)) {
        this.autoMineLevel++;
        this.autoMinePower += 0.5 * this.autoMineLevel;
        this.autoMineCost = Math.floor(this.autoMineCost * 1.9);
        return true;
      }
      return false;
    }
  }

  // ==================== Игра =======================
  class Game {
    constructor() {
      this.player = new Player();
      this.particles = [];
      this.lastAutoMineTime = 0;
      this.lastTime = 0;
      this.sparkle = 0;

      // Иконки в SVG path для кнопок (просто базовые)
      this.icons = {
        pickaxe: 'M10 2 L14 6 L10 10 L6 6 Z', // кирка
        autoMine: 'M5 10 L15 10 L10 20 Z', // лопатка или что-то
        coal: 'M12 6 L16 14 L8 16 Z'
      };

      this.setupUI();
      this.load();
      this.startLoop();
    }

    setupUI() {
      // Создаем кнопки апгрейда кирки и автодобычи
      this.pickaxeBtn = document.createElement('button');
      this.pickaxeBtn.className = 'upgrade-btn';
      this.pickaxeBtn.title = 'Улучшить кирку — увеличивает уголь за клик';
      this.pickaxeBtn.innerHTML = `<svg class="icon" viewBox="0 0 20 20"><path fill="#aaddff" d="${this.icons.pickaxe}"/></svg> Кирка: ${this.player.pickaxe.level} (Цена: ${this.player.pickaxe.upgradeCost})`;
      this.pickaxeBtn.addEventListener('click', () => this.upgradePickaxe());
      upgradeButtonsContainer.appendChild(this.pickaxeBtn);

      this.autoMineBtn = document.createElement('button');
      this.autoMineBtn.className = 'upgrade-btn';
      this.autoMineBtn.title = 'Купить авто-добычу — автоматическое получение угля каждые секунду';
      this.autoMineBtn.innerHTML = `<svg class="icon" viewBox="0 0 20 20"><path fill="#aaddff" d="${this.icons.autoMine}"/></svg> Авто-майнинг: ${this.player.autoMineLevel} (Цена: ${this.player.autoMineCost})`;
      this.autoMineBtn.addEventListener('click', () => this.buyAutoMine());
      upgradeButtonsContainer.appendChild(this.autoMineBtn);

      // Клик по холсту
      canvas.addEventListener('click', (e) => this.onCanvasClick(e));

      this.updateUI();
    }

    onCanvasClick(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const power = this.player.pickaxe.getClickPower();

      this.player.addCoal(power);
      this.spawnParticles(x, y);
      Sound.playClick();
      this.showMessage(`+${power} угля`);
      this.updateUI();
    }

    spawnParticles(x, y) {
      for(let i = 0; i < 15; i++) {
        this.particles.push(new Particle(x, y, `rgba(170, 220, 255, 1)`));
      }
    }

    upgradePickaxe() {
      if(this.player.upgradePickaxe()) {
        this.showMessage(`Кирка улучшена! Урон: ${this.player.pickaxe.getClickPower()}`);
      } else {
        this.showMessage(`Недостаточно угля для улучшения кирки!`);
      }
      this.updateUI();
    }

    buyAutoMine() {
      if(this.player.buyAutoMine()) {
        this.showMessage(`Куплен уровень авто-майнинга: ${this.player.autoMineLevel}`);
      } else {
        this.showMessage(`Недостаточно угля для авто-майнинга!`);
      }
      this.updateUI();
    }

    updateUI() {
      coalCountEl.textContent = `Уголь: ${Math.floor(this.player.coal)}`;
      perClickEl.textContent = `Клик: ${this.player.pickaxe.getClickPower()}`;
      perSecondEl.textContent = `Авто: ${this.player.autoMinePower.toFixed(1)}`;

      this.pickaxeBtn.innerHTML = `<svg class="icon" viewBox="0 0 20 20"><path fill="#aaddff" d="${this.icons.pickaxe}"/></svg> Кирка: ${this.player.pickaxe.level} (Цена: ${this.player.pickaxe.upgradeCost})`;
      this.pickaxeBtn.disabled = !this.player.canAfford(this.player.pickaxe.upgradeCost);

      this.autoMineBtn.innerHTML = `<svg class="icon" viewBox="0 0 20 20"><path fill="#aaddff" d="${this.icons.autoMine}"/></svg> Авто-майнинг: ${this.player.autoMineLevel} (Цена: ${this.player.autoMineCost})`;
      this.autoMineBtn.disabled = !this.player.canAfford(this.player.autoMineCost);
    }

    showMessage(text) {
      messagesEl.textContent = text;
      if(this.msgTimeout) clearTimeout(this.msgTimeout);
      this.msgTimeout = setTimeout(() => {
        messagesEl.textContent = '';
      }, 2500);
    }

    save() {
      const saveData = {
        coal: this.player.coal,
        pickaxe: {
          level: this.player.pickaxe.level,
          clickPower: this.player.pickaxe.clickPower,
          upgradeCost: this.player.pickaxe.upgradeCost
        },
        autoMineLevel: this.player.autoMineLevel,
        autoMinePower: this.player.autoMinePower,
        autoMineCost: this.player.autoMineCost
      };
      localStorage.setItem('ultimateMineSave', JSON.stringify(saveData));
    }

    load() {
      const saved = localStorage.getItem('ultimateMineSave');
      if(saved) {
        try {
          const data = JSON.parse(saved);
          this.player.coal = data.coal || 0;
          if(data.pickaxe) {
            this.player.pickaxe.level = data.pickaxe.level || 1;
            this.player.pickaxe.clickPower = data.pickaxe.clickPower || 1;
            this.player.pickaxe.upgradeCost = data.pickaxe.upgradeCost || 15;
          }
          this.player.autoMineLevel = data.autoMineLevel || 0;
          this.player.autoMinePower = data.autoMinePower || 0;
          this.player.autoMineCost = data.autoMineCost || 50;
        } catch {
          localStorage.removeItem('ultimateMineSave');
        }
      }
    }

    autoMineTick(time) {
      if(!this.lastAutoMineTime) this.lastAutoMineTime = time;
      if(time - this.lastAutoMineTime >= this.player.autoMineIntervalMs) {
        this.player.addCoal(this.player.autoMinePower);
        this.lastAutoMineTime = time;
        this.updateUI();
      }
    }

    drawBackground() {
      const w = canvas.width;
      const h = canvas.height;
      // Темный градиент
      let grad = ctx.createLinearGradient(0, 0, 0, h);
      grad.addColorStop(0, '#092635');
      grad.addColorStop(1, '#01151f');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);

      // Стилизация нижнего слоя камней
      for(let i=0; i<50; i++) {
        const x = (i * 40 + this.sparkle * 20) % w;
        const y = 450 + 20 * Math.sin(i + this.sparkle);
        ctx.fillStyle = `rgba(40,40,50, 0.25)`;
        ctx.beginPath();
        ctx.ellipse(x, y, 40, 18, 0, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    drawPickaxe(x, y, level) {
      ctx.save();
      ctx.translate(x, y);
      ctx.scale(1 + 0.1 * (level - 1), 1 + 0.1 * (level - 1));

      // Простой вид кирки (большой треугольник + рукоять)
      ctx.fillStyle = '#88ccff';
      ctx.beginPath();
      ctx.moveTo(0, -20);
      ctx.lineTo(20, 0);
      ctx.lineTo(0, 20);
      ctx.closePath();
      ctx.fill();

      ctx.strokeStyle = '#3366aa';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(0, 20);
      ctx.lineTo(0, 50);
      ctx.stroke();

      ctx.restore();
    }

    drawUI() {
      ctx.save();
      ctx.font = '20px Roboto Mono';
      ctx.fillStyle = '#aaddffcc';
      ctx.textAlign = 'left';
      ctx.fillText(`Уголь: ${Math.floor(this.player.coal)}`, 20, 30);
      ctx.fillText(`Клик: ${this.player.pickaxe.getClickPower()}`, 20, 60);
      ctx.fillText(`Авто: ${this.player.autoMinePower.toFixed(1)}`, 20, 90);

      ctx.textAlign = 'center';
      ctx.fillStyle = '#99bbffdd';
      ctx.font = '28px Roboto Mono';
      ctx.fillText('Нажми по холсту, чтобы добывать уголь!', canvas.width/2, 40);

      // Показываем кирку
      this.drawPickaxe(canvas.width/2, canvas.height/2 + 50, this.player.pickaxe.level);

      ctx.restore();
    }

    updateParticles() {
      for(let i = this.particles.length -1; i >= 0; i--) {
        const p = this.particles[i];
        p.update();
        if(p.alpha <= 0 || p.size <= 0.1) {
          this.particles.splice(i,1);
        }
      }
    }

    drawParticles() {
      this.particles.forEach(p => p.draw(ctx));
    }

    loop(time = 0) {
      // Обновление времени
      if(!this.lastTime) this.lastTime = time;
      const delta = time - this.lastTime;
      this.lastTime = time;

      // Обновления
      this.autoMineTick(time);
      this.updateParticles();
      this.sparkle += 0.01;

      // Отрисовка
      this.drawBackground();
      this.drawParticles();
      this.drawUI();

      requestAnimationFrame(this.loop.bind(this));
    }

    startLoop() {
      requestAnimationFrame(this.loop.bind(this));
    }
  }

  // ==================== Запуск игры =============================
  const game = new Game();

  // Автосохранение
  setInterval(() => {
    game.save();
  }, 5000);

  // Сохранять при закрытии страницы
  window.addEventListener('beforeunload', () => game.save());

})();
</script>

</body>
</html>

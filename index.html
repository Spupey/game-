<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Кликер - Добыча угля</title>
  <style>
    body {
      background: #111827;
      color: #e0e7ff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    #game {
      max-width: 480px;
      margin: 30px auto;
      background: #1f2937;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 20px #3b82f6;
    }
    h1 {
      margin-bottom: 0.3em;
      color: #3b82f6;
    }
    #coalCount, #playerLevel, #pickaxeLevel {
      font-weight: 700;
      font-size: 1.5em;
    }
    button {
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      color: white;
      font-weight: 600;
      font-size: 1.2em;
      margin: 15px 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:disabled {
      background: #6b7280;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #2563eb;
    }
    #xpBar {
      width: 100%;
      background: #374151;
      border-radius: 8px;
      overflow: hidden;
      height: 18px;
      margin: 10px 0 25px 0;
    }
    #xpFill {
      background: #60a5fa;
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }
    #shop {
      background: #111827;
      border: 1px solid #3b82f6;
      border-radius: 10px;
      max-height: 280px;
      overflow-y: auto;
      margin-top: 20px;
      display: none;
      padding: 10px;
    }
    .shop-item {
      display: flex;
      align-items: center;
      background: #1f2937;
      margin: 8px 0;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .shop-item:hover {
      background: #2563eb;
    }
    .shop-item img {
      width: 40px;
      height: 40px;
      margin-right: 15px;
    }
    .shop-item .details {
      flex-grow: 1;
      text-align: left;
    }
    .shop-item .cost {
      font-weight: 700;
      font-size: 1.1em;
      color: #a5b4fc;
      min-width: 80px;
    }
    #volumeControl {
      margin-top: 20px;
    }
    #volumeControl label {
      margin-right: 10px;
      font-size: 0.9em;
    }
    canvas {
      display: block;
      margin: 15px auto 0 auto;
      border-radius: 10px;
      background: #0f172a;
      box-shadow: 0 0 15px #3b82f6;
    }
  </style>
</head>
<body>
  <div id="game">
    <h1>Добыча угля ⛏️</h1>
    <div>Уголь: <span id="coalCount">0</span></div>
    <div>Уровень игрока: <span id="playerLevel">1</span></div>
    <div>Уровень кирки: <span id="pickaxeLevel">1</span></div>
    <div id="xpBar"><div id="xpFill"></div></div>
    <button id="mineBtn">Добыть уголь</button>
    <button id="upgradeBtn" disabled>Улучшить кирку</button>
    <button id="shopBtn">Магазин</button>

    <div id="shop"></div>

    <div id="volumeControl">
      <label for="volumeRange">Громкость звуков:</label>
      <input type="range" id="volumeRange" min="0" max="1" step="0.01" value="0.2" />
    </div>

    <canvas id="canvas" width="480" height="360"></canvas>

    <audio id="clickSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
    <audio id="upgradeSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
    <audio id="bgMusic" src="https://cdn.pixabay.com/download/audio/2022/03/29/audio_4a68ac61bb.mp3?filename=relaxing-piano-background-7081.mp3" loop></audio>
  </div>

  <script>
    const coalCountEl = document.getElementById('coalCount');
    const playerLevelEl = document.getElementById('playerLevel');
    const pickaxeLevelEl = document.getElementById('pickaxeLevel');
    const xpFillEl = document.getElementById('xpFill');
    const mineBtn = document.getElementById('mineBtn');
    const upgradeBtn = document.getElementById('upgradeBtn');
    const shopBtn = document.getElementById('shopBtn');
    const shopEl = document.getElementById('shop');
    const volumeRange = document.getElementById('volumeRange');

    const clickSound = document.getElementById('clickSound');
    const upgradeSound = document.getElementById('upgradeSound');
    const bgMusic = document.getElementById('bgMusic');

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let game = {
      coal: 0,
      pickaxeLevel: 1,
      pickaxePower: 1,
      xp: 0,
      playerLevel: 1,
      xpToNextLevel: 100,
      autoMineRate: 0,
      autoMineInterval: null,
      doubleCoal: false,
      extraXP: false,
      volume: 0.2,
    };

    const pickaxeIcons = [
      "https://cdn-icons-png.flaticon.com/512/1375/1375492.png",
      "https://cdn-icons-png.flaticon.com/512/1607/1607535.png",
      "https://cdn-icons-png.flaticon.com/512/1355/1355626.png",
      "https://cdn-icons-png.flaticon.com/512/891/891462.png",
      "https://cdn-icons-png.flaticon.com/512/744/744922.png",
    ];

    const shopItems = [
      {
        id: 'autoMiner',
        name: 'Автокопатель',
        description: 'Автоматически добывает уголь каждую секунду',
        cost: 100,
        power: 1,
        icon: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        bought: 0,
        max: 5,
      },
      {
        id: 'doubleCoal',
        name: 'Удвоение добычи',
        description: 'Двойная добыча угля за клик',
        cost: 300,
        icon: 'https://cdn-icons-png.flaticon.com/512/1828/1828884.png',
        bought: false,
      },
      {
        id: 'extraXP',
        name: 'Опыт +50%',
        description: 'Получай больше опыта за добычу',
        cost: 200,
        icon: 'https://cdn-icons-png.flaticon.com/512/2921/2921822.png',
        bought: false,
      }
    ];

    // Частицы
    let particles = [];

    function createParticle(x, y) {
      particles.push({
        x: x,
        y: y,
        vx: (Math.random() - 0.5) * 3,
        vy: -Math.random() * 3 - 2,
        alpha: 1,
        size: 8 + Math.random() * 4,
      });
    }

    function updateParticles() {
      particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.1;
        p.alpha -= 0.02;
      });
      particles = particles.filter(p => p.alpha > 0);
    }

    function drawParticles() {
      particles.forEach(p => {
        ctx.save();
        ctx.globalAlpha = p.alpha;
        ctx.fillStyle = '#44bbff';
        ctx.beginPath();
        ctx.ellipse(p.x, p.y, p.size * 0.7, p.size * 0.5, Math.PI / 4, 0, 2 * Math.PI);
        ctx.fill();
        ctx.restore();
      });
    }

    function updateUI() {
      coalCountEl.textContent = Math.floor(game.coal);
      pickaxeLevelEl.textContent = game.pickaxeLevel;
      playerLevelEl.textContent = game.playerLevel;

      let percentXP = Math.min(100, (game.xp / game.xpToNextLevel) * 100);
      xpFillEl.style.width = percentXP + '%';

      upgradeBtn.disabled = game.coal < upgradeCost();

      let iconIndex = Math.min(game.pickaxeLevel - 1, pickaxeIcons.length - 1);
      upgradeBtn.innerHTML = `<img src="${pickaxeIcons[iconIndex]}" class="icon" alt="Кирка" style="width:24px;vertical-align:middle;margin-right:6px"/> Улучшить кирку (${upgradeCost()} угля)`;
    }

    function upgradeCost() {
      return Math.floor(50 * Math.pow(1.7, game.pickaxeLevel - 1));
    }

    function mineClick() {
      let coalGain = game.pickaxePower;
      if (game.doubleCoal) coalGain *= 2;
      game.coal += coalGain;

      let xpGain = 5;
      if (game.extraXP) xpGain = Math.floor(xpGain * 1.5);
      gainXP(xpGain);

      playSound(clickSound);
      createParticle(400 + Math.random() * 100, 300 + Math.random() * 50);
      updateUI();
    }

    function upgradePickaxe() {
      let cost = upgradeCost();
      if (game.coal >= cost) {
        game.coal -= cost;
        game.pickaxeLevel++;
        game.pickaxePower += 1;

        // Бонус за каждый 3-й уровень: +1 к автоматической добыче, если есть автокопатели
        if (game.pickaxeLevel % 3 === 0 && game.autoMineRate > 0) {
          game.autoMineRate += 1;
        }

        playSound(upgradeSound);
        updateUI();
      }
    }

    function gainXP(amount) {
      game.xp += amount;
      if (game.xp >= game.xpToNextLevel) {
        game.xp -= game.xpToNextLevel;
        game.playerLevel++;
        game.xpToNextLevel = Math.floor(game.xpToNextLevel * 1.5);

        // Бонус за уровень — +1 к кирке каждые 5 уровней
        if (game.playerLevel % 5 === 0) {
          game.pickaxePower++;
          playSound(upgradeSound);
        }
      }
      updateUI();
    }

    function openShop() {
      if (shopEl.style.display === 'block') {
        shopEl.style.display = 'none';
      } else {
        renderShop();
        shopEl.style.display = 'block';
      }
    }

    function renderShop() {
      shopEl.innerHTML = '';
      shopItems.forEach(item => {
        const div = document.createElement('div');
        div.classList.add('shop-item');

        let costText = '';
        if (item.bought === true) costText = 'Куплено';
        else if (typeof item.bought === 'number') {
          if (item.bought >= item.max) costText = 'Максимум';
          else costText = item.cost + '⛏️';
        } else costText = item.cost + '⛏️';

        div.innerHTML = `
          <img src="${item.icon}" alt="${item.name}" />
          <div class="details">
            <h3>${item.name}</h3>
            <p>${item.description}</p>
          </div>
          <div class="cost">${costText}</div>
        `;

        if (costText !== 'Куплено' && costText !== 'Максимум') {
          div.style.cursor = 'pointer';
          div.onclick = () => buyShopItem(item);
        } else {
          div.style.opacity = '0.5';
          div.style.cursor = 'default';
        }
        shopEl.appendChild(div);
      });
    }

    function buyShopItem(item) {
      if (game.coal < item.cost) return alert('Недостаточно угля для покупки!');
      if (item.bought === true) return alert('Вы уже купили этот предмет!');
      if (typeof item.bought === 'number' && item.bought >= item.max) return alert('Максимальное количество достигнуто!');

      game.coal -= item.cost;

      if (item.id === 'autoMiner') {
        item.bought++;
        game.autoMineRate += item.power;
        if (!game.autoMineInterval) {
          game.autoMineInterval = setInterval(() => {
            game.coal += game.autoMineRate;
            gainXP(game.autoMineRate);
            updateUI();
          }, 1000);
        }
      } else if (item.id === 'doubleCoal') {
        game.doubleCoal = true;
        item.bought = true;
      } else if (item.id === 'extraXP') {
        game.extraXP = true;
        item.bought = true;
      }

      playSound(upgradeSound);
      renderShop();
      updateUI();
    }

    function playSound(audioEl) {
      audioEl.volume = game.volume;
      audioEl.currentTime = 0;
      audioEl.play().catch(() => {});
    }

    volumeRange.addEventListener('input', () => {
      game.volume = parseFloat(volumeRange.value);
      bgMusic.volume = game.volume * 0.5;
    });

    function startMusic() {
      bgMusic.volume = game.volume * 0.5;
      bgMusic.play().catch(() => {});
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawStars();
      updateParticles();
      drawParticles();
      requestAnimationFrame(gameLoop);
    }

    const stars = [];
    for (let i = 0; i < 80; i++) {
      stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 2 + 1,
        alpha: Math.random(),
        delta: 0.01 + Math.random() * 0.02,
      });
    }

    function drawStars() {
      stars.forEach(star => {
        star.alpha += star.delta;
        if (star.alpha >= 1 || star.alpha <= 0.3) star.delta *= -1;
        ctx.fillStyle = `rgba(180, 220, 255, ${star.alpha})`;
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.size, 0, 2 * Math.PI);
        ctx.fill();
      });
    }

    mineBtn.addEventListener('click', mineClick);
    upgradeBtn.addEventListener('click', upgradePickaxe);
    shopBtn.addEventListener('click', openShop);

    updateUI();
    gameLoop();
    startMusic();
  </script>
</body>
</html>

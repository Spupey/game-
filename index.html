<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Deep Mine Clicker — Полноценный кликер</title>
<style>
  /* Общий стиль */
  body {
    margin: 0;
    background: #101820;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #eee;
    user-select: none;
    overflow: hidden;
  }
  #gameCanvas {
    display: block;
    margin: 20px auto 0;
    background: #15202b;
    border-radius: 20px;
    box-shadow: 0 0 30px #001522aa;
  }
  #uiPanel {
    width: 720px;
    margin: 20px auto;
    background: rgba(10, 20, 35, 0.95);
    border-radius: 20px;
    box-shadow: 0 0 20px #224488cc;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #stats, #upgrades {
    display: flex;
    gap: 25px;
  }
  #stats > div, #upgrades > button {
    font-size: 18px;
    font-weight: 700;
  }
  button {
    background: #214270;
    color: #aaccff;
    border: none;
    border-radius: 12px;
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s ease;
    box-shadow: 0 4px 10px #184060aa;
  }
  button:disabled {
    background: #0a2a4a;
    color: #557799;
    cursor: not-allowed;
    box-shadow: none;
  }
  button:hover:not(:disabled) {
    background: #2e5a98;
  }
  #messages {
    width: 720px;
    margin: 0 auto;
    height: 24px;
    color: #88cc88;
    font-weight: 600;
    font-size: 16px;
    text-align: center;
    user-select: none;
  }
</style>
</head>
<body>

<div id="uiPanel">
  <div id="stats">
    <div id="coalCount">Уголь: 0</div>
    <div id="perClick">За клик: 1</div>
    <div id="perSecond">Авто добыча: 0</div>
  </div>
  <div id="upgrades">
    <button id="upgradePickaxeBtn">Улучшить кирку (15)</button>
    <button id="upgradeAutoMineBtn">Авто-добыча (30)</button>
  </div>
</div>
<div id="messages"></div>
<canvas id="gameCanvas" width="720" height="450"></canvas>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  // Аудиоконтекст для звуков
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AudioContext();

  // Функция звука клика (короткий "щелчок")
  function playClickSound() {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(400 + Math.random()*300, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
  }

  // Класс Игрока (статистика, ресурсы)
  class Player {
    constructor() {
      this.coal = 0;
      this.coalPerClick = 1;
      this.coalPerSecond = 0;
      this.pickaxeLevel = 1;
      this.pickaxeUpgradeCost = 15;
      this.autoMineLevel = 0;
      this.autoMineUpgradeCost = 30;
    }

    addCoal(amount) {
      this.coal += amount;
    }

    canBuy(cost) {
      return this.coal >= cost;
    }

    buyPickaxeUpgrade() {
      if(this.canBuy(this.pickaxeUpgradeCost)) {
        this.coal -= this.pickaxeUpgradeCost;
        this.pickaxeLevel++;
        this.coalPerClick *= 1.5;
        this.pickaxeUpgradeCost = Math.floor(this.pickaxeUpgradeCost * 2.5);
        return true;
      }
      return false;
    }

    buyAutoMineUpgrade() {
      if(this.canBuy(this.autoMineUpgradeCost)) {
        this.coal -= this.autoMineUpgradeCost;
        this.autoMineLevel++;
        this.coalPerSecond += 1;
        this.autoMineUpgradeCost = Math.floor(this.autoMineUpgradeCost * 3);
        return true;
      }
      return false;
    }
  }

  // Класс Частицы для анимации (пыли, искр)
  class Particle {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.size = 3 + Math.random()*4;
      this.speedX = (Math.random()-0.5)*2;
      this.speedY = -1 - Math.random()*2;
      this.alpha = 1;
      this.decay = 0.02 + Math.random()*0.02;
      this.color = `rgba(200,200,200,${this.alpha})`;
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      this.alpha -= this.decay;
      this.size *= 0.95;
    }
    draw(ctx) {
      ctx.save();
      ctx.fillStyle = `rgba(200,200,200,${this.alpha})`;
      ctx.beginPath();
      ctx.ellipse(this.x, this.y, this.size, this.size*0.6, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  }

  // Основной класс игры
  class Game {
    constructor() {
      this.player = new Player();
      this.particles = [];
      this.lastAutoMineTime = 0;
      this.autoMineInterval = 2000;
      this.sparkle = 0;
      this.flamePhase = 0;

      // UI элементы
      this.coalCountEl = document.getElementById('coalCount');
      this.perClickEl = document.getElementById('perClick');
      this.perSecondEl = document.getElementById('perSecond');
      this.upgradePickaxeBtn = document.getElementById('upgradePickaxeBtn');
      this.upgradeAutoMineBtn = document.getElementById('upgradeAutoMineBtn');
      this.messagesEl = document.getElementById('messages');

      // Привязка событий
      canvas.addEventListener('click', (e) => this.handleClick(e));
      this.upgradePickaxeBtn.addEventListener('click', () => this.buyPickaxeUpgrade());
      this.upgradeAutoMineBtn.addEventListener('click', () => this.buyAutoMineUpgrade());

      this.loadProgress();
      this.updateUI();
      requestAnimationFrame((time) => this.gameLoop(time));
    }

    handleClick(e) {
      this.player.addCoal(this.player.coalPerClick);
      this.spawnParticles(e.offsetX, e.offsetY);
      playClickSound();
      this.updateUI();
      this.showMessage(`+${this.player.coalPerClick} угля`);
    }

    spawnParticles(x, y) {
      for(let i=0; i<8; i++) {
        this.particles.push(new Particle(x, y));
      }
    }

    buyPickaxeUpgrade() {
      if(this.player.buyPickaxeUpgrade()) {
        this.updateUI();
        this.showMessage(`Кирка улучшена до уровня ${this.player.pickaxeLevel}!`);
        this.saveProgress();
      } else {
        this.showMessage(`Недостаточно угля для улучшения кирки!`);
      }
    }

    buyAutoMineUpgrade() {
      if(this.player.buyAutoMineUpgrade()) {
        this.updateUI();
        this.showMessage(`Авто-добыча улучшена до уровня ${this.player.autoMineLevel}!`);
        this.saveProgress();
      } else {
        this.showMessage(`Недостаточно угля для авто-добычи!`);
      }
    }

    updateUI() {
      this.coalCountEl.textContent = `Уголь: ${Math.floor(this.player.coal)}`;
      this.perClickEl.textContent = `За клик: ${Math.floor(this.player.coalPerClick)}`;
      this.perSecondEl.textContent = `Авто добыча: ${Math.floor(this.player.coalPerSecond)}`;
      this.upgradePickaxeBtn.textContent = `Улучшить кирку (${this.player.pickaxeUpgradeCost})`;
      this.upgradeAutoMineBtn.textContent = `Авто-добыча (${this.player.autoMineUpgradeCost})`;
      this.upgradePickaxeBtn.disabled = !this.player.canBuy(this.player.pickaxeUpgradeCost);
      this.upgradeAutoMineBtn.disabled = !this.player.canBuy(this.player.autoMineUpgradeCost);
    }

    showMessage(text) {
      this.messagesEl.textContent = text;
      clearTimeout(this.msgTimeout);
      this.msgTimeout = setTimeout(() => {
        this.messagesEl.textContent = '';
      }, 2500);
    }

    saveProgress() {
      const saveData = {
        coal: this.player.coal,
        coalPerClick: this.player.coalPerClick,
        coalPerSecond: this.player.coalPerSecond,
        pickaxeLevel: this.player.pickaxeLevel,
        pickaxeUpgradeCost: this.player.pickaxeUpgradeCost,
        autoMineLevel: this.player.autoMineLevel,
        autoMineUpgradeCost: this.player.autoMineUpgradeCost,
      };
      localStorage.setItem('deepMineSave', JSON.stringify(saveData));
    }

    loadProgress() {
      const saved = localStorage.getItem('deepMineSave');
      if(saved) {
        try {
          const data = JSON.parse(saved);
          Object.assign(this.player, data);
        } catch {
          // Ошибка в сохранении — сбросить
          localStorage.removeItem('deepMineSave');
        }
      }
    }

    autoMineTick(time) {
      if(this.player.autoMineLevel > 0 && time - this.lastAutoMineTime > this.autoMineInterval) {
        this.player.addCoal(this.player.coalPerSecond);
        this.lastAutoMineTime = time;
        this.updateUI();
      }
    }

    drawBackground() {
      const w = canvas.width;
      const h = canvas.height;

      // Градиент фона шахты (синий к темно-синему)
      let grad = ctx.createLinearGradient(0, 0, 0, h);
      grad.addColorStop(0, '#0f1f30');
      grad.addColorStop(1, '#050a12');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);

      // Камни шахты - размытые овалы
      for(let i=0; i<40; i++) {
        let x = (i * 40 + (this.sparkle * 30)) % w;
        let y = 320 + 40 * Math.sin(i * 1.3 + this.sparkle);
        let sizeX = 50 + 10 * Math.sin(i + this.sparkle);
        let sizeY = 30 + 5 * Math.cos(i + this.sparkle);
        ctx.fillStyle = `rgba(80,80,80,0.3)`;
        ctx.beginPath();
        ctx.ellipse(x, y, sizeX, sizeY, 0, 0, Math.PI*2);
        ctx.fill();
      }

      // Факелы по бокам
      this.drawTorch(40, 100, 1, this.flamePhase);
      this.drawTorch(w - 40, 100, 1, this.flamePhase + Math.PI);
    }

    drawTorch(x, y, scale, phase) {
      ctx.save();
      ctx.translate(x, y);
      ctx.scale(scale, scale);
      ctx.shadowColor = 'rgba(255, 140, 50, 0.9)';
      ctx.shadowBlur = 10;

      // Деревянная основа
      ctx.fillStyle = '#4a2f0a';
      ctx.fillRect(-6, 0, 12, 50);

      // Пламя
      let flameHeight = 40 + 8 * Math.sin(phase * 8);
      ctx.fillStyle = `rgba(255, 140, 50, ${0.6 + 0.4 * Math.sin(phase * 8)})`;
      ctx.beginPath();
      ctx.moveTo(0, -flameHeight);
      ctx.bezierCurveTo(-12, -flameHeight / 2, -6, -flameHeight * 1.5, 0, -flameHeight);
      ctx.bezierCurveTo(6, -flameHeight * 1.5, 12, -flameHeight / 2, 0, -flameHeight);
      ctx.fill();

      ctx.restore();
      ctx.shadowBlur = 0;
    }

    drawCoal() {
      let x = canvas.width / 2;
      let y = 280;

      ctx.save();
      ctx.translate(x, y);

      // Тень
      ctx.fillStyle = 'rgba(10, 10, 10, 0.9)';
      ctx.beginPath();
      ctx.ellipse(40, 60, 50, 30, 0, 0, 2 * Math.PI);
      ctx.fill();

      // Основной уголь (черные камни с блеском)
      ctx.fillStyle = `rgba(20, 20, 20, 1)`;
      ctx.shadowColor = '#555';
      ctx.shadowBlur = 12;
      ctx.beginPath();
      ctx.ellipse(40, 60, 50, 30, 0, 0, 2 * Math.PI);
      ctx.fill();

      ctx.shadowBlur = 0;
      ctx.fillStyle = `#111`;
      ctx.beginPath();
      ctx.moveTo(10, 70);
      ctx.lineTo(70, 70);
      ctx.lineTo(60, 110);
      ctx.lineTo(20, 110);
      ctx.closePath();
      ctx.fill();

      ctx.strokeStyle = '#222';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Мерцающее пламя угля
      let flameHeight = 40 + 10 * Math.sin(this.sparkle * 8);
      ctx.fillStyle = `rgba(255, 140, 50, ${0.4 + 0.6 * Math.sin(this.sparkle * 8)})`;
      ctx.beginPath();
      ctx.moveTo(40, 10);
      ctx.bezierCurveTo(20, 30, 30, -10, 40, 10);
      ctx.bezierCurveTo(50, -10, 60, 30, 40, 10);
      ctx.fill();

      ctx.restore();
    }

    drawPickaxe(x, y, scale = 1) {
      ctx.save();
      ctx.translate(x, y);
      ctx.scale(scale, scale);
      ctx.shadowColor = 'rgba(0,0,0,0.8)';
      ctx.shadowBlur = 6;

      // Рукоять
      ctx.fillStyle = '#553311';
      ctx.fillRect(-10, 0, 20, 100);

      // Лезвие кирки
      ctx.fillStyle = '#aaa';
      ctx.beginPath();
      ctx.moveTo(-35, 20);
      ctx.lineTo(-10, 40);
      ctx.lineTo(10, 40);
      ctx.lineTo(35, 10);
      ctx.lineTo(20, -20);
      ctx.closePath();
      ctx.fill();

      ctx.restore();
      ctx.shadowBlur = 0;
    }

    updateParticles() {
      this.particles = this.particles.filter(p => p.alpha > 0.05);
      for(let p of this.particles) p.update();
    }

    drawParticles() {
      for(let p of this.particles) p.draw(ctx);
    }

    gameLoop(time = 0) {
      this.sparkle += 0.03;
      this.flamePhase += 0.1;

      this.drawBackground();
      this.drawPickaxe(100, 250, 1.5);
      this.drawCoal();
      this.updateParticles();
      this.drawParticles();

      this.autoMineTick(time);

      requestAnimationFrame((t) => this.gameLoop(t));
    }
  }

  // Запуск игры
  const game = new Game();

  // Автосохранение раз в 5 секунд
  setInterval(() => game.saveProgress(), 5000);
})();
</script>

</body>
</html>
